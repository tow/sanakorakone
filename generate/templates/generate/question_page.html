<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>Sanakorakone</title>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	</head>
	<body>

		<div class="container-fluid">
			<div class="row">
				<h1 class="center-block display-4">Sanakorakone</h1>
			</div>
			<div class="row">
				<div class="col">
					<div class="card">
						<div class="card-body">
							<h3 class="card-title" id="infinitive"></h3>
							<h4 class="card-subtitle mb-2 text-muted"><span id="negative"></span> <span id="tense"></span></h4>
						</div>
					</div>
				</div>
			</div>

			<form>
				<div class="row">
					<div class="col">
						<div class="input-group input-group-lg">
							<div class="input-group-prepend">
								<span class="input-group-text" id="person"></span>
							</div>
							<input type="text" class="form-control" aria-label="Answer" aria-describedby="person" id="answer" autofocus>
						</div>
					</div>
				</div>
				<hr/>
				<div class="row">
					<div class="col">
						<button class="btn btn-lg btn-primary btn-block" id="check">Tarkista</button>
					</div>
					<div class="col">
						<button class="btn btn-lg btn-secondary btn-block" id="new">Uudelleen</button>
					</div>
				</div>
				<hr/>
				<div class="row">
					<div class="col alert lead" id="judgment">
					</div>
				</div>
				<div class="row">
					<div class="col">
						<table class="table">
							<thead>
								<tr>
									<th scope="col"></th>
									<th scope="col">Right</span</th>
									<th scope="col">Total</th>
									<th scope="col">Percent</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<th scope="row">Overall</th>
									<td><span id="rights"></span></td>
									<td><span id="wrongs"></span></td>
									<td><span id="percent"></span></td>
								</tr>
							</tbody>
						</table>	
					</div>
				</div>
				<div class="row">
					<div class="col">
						<a class="btn button-sm btn-outline-secondary" onClick="clear_scores();" role="button" aria-expanded="false">Tyhjentä pisteet</a>
					</div>
					<div class="col">
						<a class="btn button-sm btn-outline-secondary" data-toggle="collapse" href="#options-row" role="button" aria-expanded="false" aria-controls="options-row">Vaihtoehdot</a>
					</div>
				</div>
				<div class="row collapse" id="options-row">
					<div class="col">
						<div class="form-group">
							<label for="tense">Aikamuoto</label>
							<select multiple class="form-control" id="tense" name="tense">
								<option>preseens</option>
								<option>imperfekti</option>
								<option>perfekti</option>
								<option>plusqvamperfekti</option>
							</select>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="" id="ignore_negative" name="ignore_negative">
							<label class="form-check-label" for="ignore_negative">Sivuutta negatiivista</label>
						</div>
						<div class="form-group">
							<label for="verbtype">Verbityyppi</label>
							<select multiple class="form-control" id="verbtype" name="verbtype">
								<option>1</option>
								<option>2</option>
								<option>3</option>
								<option>4</option>
								<option>5</option>
								<option>6</option>
							</select>
						</div>
						<div class="form-group">
							<label for="verb">Verbi</label>
							<input class="form-control" id="verb" name="verb"></input>
						</div>
					</div>
				</div>
			</form>	
		</div>
		<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

		<script>
			/*
			* Javascript Diff Algorithm
			 *  By John Resig (http://ejohn.org/)
			 *  Modified by Chu Alan "sprite"
			 *
			 * Released under the MIT license.
			 *
			 * More Info:
			 *  http://ejohn.org/projects/javascript-diff-algorithm/
			 */

function escape(s) {
	var n = s;
	n = n.replace(/&/g, "&amp;");
	n = n.replace(/</g, "&lt;");
	n = n.replace(/>/g, "&gt;");
	n = n.replace(/"/g, "&quot;");

	return n;
}

function diffString( o, n ) {
	o = o.replace(/\s+$/, '');
	n = n.replace(/\s+$/, '');

	var out = diff(o == "" ? [] : o.split(""), n == "" ? [] : n.split("") );
	var str = "";

	if (out.n.length == 0) {
		for (var i = 0; i < out.o.length; i++) {
			str += '<del>' + escape(out.o[i]) + "</del>";
		}
	} else {
		if (out.n[0].text == null) {
			for (n = 0; n < out.o.length && out.o[n].text == null; n++) {
				str += '<del>' + escape(out.o[n]) + "</del>";
			}
		}

		for ( var i = 0; i < out.n.length; i++ ) {
			if (out.n[i].text == null) {
				str += '<ins>' + escape(out.n[i]) + "</ins>";
			} else {
				var pre = "";

				for (n = out.n[i].row + 1; n < out.o.length && out.o[n].text == null; n++ ) {
					pre += '<del>' + escape(out.o[n]) + "</del>";
				}
				str += out.n[i].text + pre;
			}
		}
	}

	return str;
}

function diff( o, n ) {
	var ns = new Object();
	var os = new Object();

	for ( var i = 0; i < n.length; i++ ) {
		if ( ns[ n[i] ] == null )
			ns[ n[i] ] = { rows: new Array(), o: null };
		ns[ n[i] ].rows.push( i );
	}

	for ( var i = 0; i < o.length; i++ ) {
		if ( os[ o[i] ] == null )
			os[ o[i] ] = { rows: new Array(), n: null };
		os[ o[i] ].rows.push( i );
	}

	for ( var i in ns ) {
		if ( ns[i].rows.length == 1 && typeof(os[i]) != "undefined" && os[i].rows.length == 1 ) {
			n[ ns[i].rows[0] ] = { text: n[ ns[i].rows[0] ], row: os[i].rows[0] };
			o[ os[i].rows[0] ] = { text: o[ os[i].rows[0] ], row: ns[i].rows[0] };
		}
	}

	for ( var i = 0; i < n.length - 1; i++ ) {
																					if ( n[i].text != null && n[i+1].text == null && n[i].row + 1 < o.length && o[ n[i].row + 1 ].text == null && 
																					n[i+1] == o[ n[i].row + 1 ] ) {
																					n[i+1] = { text: n[i+1], row: n[i].row + 1 };
																					o[n[i].row+1] = { text: o[n[i].row+1], row: i + 1 };
																					}
																					}

																					for ( var i = n.length - 1; i > 0; i-- ) {
																						if ( n[i].text != null && n[i-1].text == null && n[i].row > 0 && o[ n[i].row - 1 ].text == null && 
																							n[i-1] == o[ n[i].row - 1 ] ) {
																							n[i-1] = { text: n[i-1], row: n[i].row - 1 };
																							o[n[i].row-1] = { text: o[n[i].row-1], row: i - 1 };
																						}
																					}

	return { o: o, n: n };
}

var show_negative = function(neg) {
	if (neg) {
		$("#negative").text("negatiivinen");
	} else {
		$("#negative").text("");
	}
};

var populate_question = function(data) {
	$("#infinitive").text(data.infinitive);
	$("#person").text(data.person);
	$("#tense").text(data.tense);
	show_negative(data.negative);
	var check_answer = function() {
		var user_answer = $("#answer").val().toLowerCase().trim();
		if (user_answer == data.answer) {
			$("#judgment").text("✔ Kyllä!").removeClass("alert-danger").addClass("alert-success");
			scores.rights[data.index]++;
		} else {
			var answerdiff = diffString(user_answer, data.answer)
			$("#judgment").html("✘ "+answerdiff+'<br>'+data.answer).removeClass("alert-success").addClass("alert-danger");
			scores.wrongs[data.index]++;
		}
		localStorage.setItem("scores", JSON.stringify(scores));
		display_scores();
		$("#check").removeClass("btn-primary").addClass("btn-secondary").removeAttr('type');
		$("#new").removeClass("btn-secondary").addClass("btn-primary").attr('type', 'submit');
		$("form").off('submit').on('submit', function(e) {
			e.preventDefault();
			get_question();
		});
	};
	$("#check").removeClass("btn-secondary").addClass("btn-primary").attr('type', 'submit');
	$("#new").removeClass("btn-primary").addClass("btn-secondary").removeAttr('type');
	$("form").off('submit').on('submit', function(e) {
		e.preventDefault();
		check_answer();
	});
};

var get_question = function() {
	$.getJSON("/generate_example/?"+$("form").serialize(), populate_question);
	$("#answer").val('');
	$("#judgment").text('').removeClass("alert-danger alert-success");
};

var get_scores = function() {
	var total_wrongs = 0;
	var total_rights = 0;
	for (let k in scores.rights) {
		total_rights += scores.rights[k];
	}
	for (let k in scores.wrongs) {
		total_wrongs += scores.wrongs[k];
	}
	var total = total_rights + total_wrongs;
	return {
		"rights": total_rights,
		"wrongs": total_wrongs,
		"percent": 100.0 * total_rights / total || 0
	};
};

var display_scores = function() {
	var scores = get_scores();
	$("#rights").text(scores.rights);
	$("#wrongs").text(scores.wrongs);
	$("#percent").text(Math.round(100*scores.percent)/100);
}

var scores;
var setup_scores = function() {
	scores = localStorage.getItem("scores");
	if (scores) {
		scores = JSON.parse(scores);
	} else {
		// array key is {verbtype|tense|negation|person}
		// verbtype 1 to 6
		// tense 1 = present, 2 = imperfect, 3 = perfect, 4 = pluperfect
		// negation 1 = positive, 2 = negative
		// person 1 = SG1, ... 6 = PL3
		scores = {"rights": {}, "wrongs": {}};
		for (var verbtype=1; verbtype<7; verbtype++) {
			for (var tense=1; tense<5; tense++) {
				for (var negative=1; negative<3; negative++) {
					for (var person=1; person<7; person++) {
						var index =	
							verbtype.toString() +
							tense.toString() +
							negative.toString() +
							person.toString();
						scores.rights[index] = 0;
						scores.wrongs[index] = 0;
					}
				}
			}
		}
		localStorage.setItem("scores", JSON.stringify(scores));
	}
};
var clear_scores = function() {
	scores = null;
	localStorage.removeItem("scores");
	setup_scores();
	display_scores();
};

$(document).ready( function() {
	setup_scores();
	display_scores();
	get_question();
});
		</script>
	</body>
</html>
