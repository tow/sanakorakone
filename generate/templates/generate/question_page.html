<!DOCTYPE html>
{% load static %}
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>Sanakorakone</title>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	</head>
	<body>

		<div class="container-fluid">
			<div class="row">
				<h1 class="center-block display-4">Sanakorakone</h1>
			</div>
			<div class="row">
				<div class="col">
					<div class="card">
						<div class="card-body">
							<h3 class="card-title" id="infinitive"></h3>
							<h4 class="card-subtitle mb-2 text-muted"><span id="negative"></span> <span id="tense"></span></h4>
						</div>
					</div>
				</div>
			</div>

			<form>
				<div class="row">
					<div class="col">
						<div class="input-group input-group-lg">
							<div class="input-group-prepend">
								<span class="input-group-text" id="person"></span>
							</div>
							<input type="text" class="form-control" aria-label="Answer" aria-describedby="person" id="answer" autocapitalize="off" spellcheck="false" autocomplete="off" autocorrect="off" autofocus>
						</div>
					</div>
				</div>
				<hr/>
				<div class="row">
					<div class="col">
						<button class="btn btn-lg btn-primary btn-block" id="check">Tarkista</button>
					</div>
					<div class="col">
						<button class="btn btn-lg btn-secondary btn-block" id="new">Uudelleen</button>
					</div>
				</div>
				<hr/>
				<div class="row">
					<div class="col alert lead" id="judgment">
					</div>
				</div>
				<div class="row">
					<div class="col">
						<table class="table">
							<thead>
								<tr>
									<th scope="col"></th>
									<th scope="col">Right</span</th>
									<th scope="col">Total</th>
									<th scope="col">Percent</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<th scope="row">Overall</th>
									<td><span id="rights"></span></td>
									<td><span id="total"></span></td>
									<td><span id="percent"></span></td>
								</tr>
							</tbody>
						</table>	
					</div>
				</div>
				<div class="row">
					<div class="col">
						<a class="btn button-sm btn-outline-secondary" onClick="clear_scores();" role="button" aria-expanded="false">Tyhjentä pisteet</a>
					</div>
					<div class="col">
						<a class="btn button-sm btn-outline-secondary" data-toggle="collapse" href="#options-row" role="button" aria-expanded="false" aria-controls="options-row">Vaihtoehdot</a>
					</div>
				</div>
				<div class="row collapse" id="options-row">
					<div class="col">
						<div class="form-group">
							<label for="tense">Aikamuoto</label>
							<select multiple class="form-control" id="tense" name="tense">
								<option>preseens</option>
								<option>imperfekti</option>
								<option>perfekti</option>
								<option>plusqvamperfekti</option>
							</select>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="" id="ignore_negative" name="ignore_negative">
							<label class="form-check-label" for="ignore_negative">Sivuutta negatiivista</label>
						</div>
						<div class="form-group">
							<label for="verbtype">Verbityyppi</label>
							<select multiple class="form-control" id="verbtype" name="verbtype">
								<option>1</option>
								<option>2</option>
								<option>3</option>
								<option>4</option>
								<option>5</option>
								<option>6</option>
							</select>
						</div>
						<div class="form-group">
							<label for="verb">Verbi</label>
							<input class="form-control" id="verb" name="verb"></input>
						</div>
					</div>
				</div>
			</form>	
		</div>
		<script src="{% static "generate/jquery-3.4.1.min.js" %}"></script>
		<script src="{% static "generate/popper-1.12.9.min.js" %}"></script>
		<script src="{% static "generate/bootstrap-4.0.0.min.js" %}"></script>
		<script src="{% static "generate/diff_match_patch.js" %}"></script>

		<script>

function escape(s) {
       var n = s;
       n = n.replace(/&/g, "&amp;");
       n = n.replace(/</g, "&lt;");
       n = n.replace(/>/g, "&gt;");
       n = n.replace(/"/g, "&quot;");

       return n;
}


var show_negative = function(neg) {
	if (neg) {
		$("#negative").text("negatiivinen");
	} else {
		$("#negative").text("");
	}
};

var populate_question = function(data) {
	$("#infinitive").text(data.infinitive);
	$("#person").text(data.person);
	$("#tense").text(data.tense);
	show_negative(data.negative);
	var check_answer = function() {
		var user_answer = $("#answer").val().toLowerCase().trim();
		if (user_answer == data.answer) {
			$("#judgment").text("✔ Kyllä!").removeClass("alert-danger").addClass("alert-success");
			window.scores.rights[data.index]++;
		} else {
			var dmp = new diff_match_patch();
                        var diff = dmp.diff_main(user_answer, data.answer);
                        dmp.diff_cleanupSemantic(diff);
                        // Result: [(-1, "Hello"), (1, "Goodbye"), (0, " World.")]
			console.log(diff);
			var answerdiff = "";
			for (let k in diff) {
				console.log(k);
				let d = diff[k];
				if (d[0] == -1) {
					answerdiff += "<del>" + escape(d[1]) + "</del>";
				} else if (d[0] == 1) {
					answerdiff += "<ins>" + escape(d[1]) + "</ins>";
				} else {
					answerdiff += escape(d[1]);
				}
			}
			$("#judgment").html("✘ "+answerdiff+'<br>'+data.answer).removeClass("alert-success").addClass("alert-danger");
			window.scores.wrongs[data.index]++;
		}
		localStorage.setItem("scores", JSON.stringify(window.scores));
		display_scores();
		$("#check").removeClass("btn-primary").addClass("btn-secondary").removeAttr('type');
		$("#new").removeClass("btn-secondary").addClass("btn-primary").attr('type', 'submit');
		$("form").off('submit').on('submit', function(e) {
			e.preventDefault();
			get_question();
		});
	};
	$("#check").removeClass("btn-secondary").addClass("btn-primary").attr('type', 'submit');
	$("#new").removeClass("btn-primary").addClass("btn-secondary").removeAttr('type');
	$("form").off('submit').on('submit', function(e) {
		e.preventDefault();
		check_answer();
	});
};

var get_question = function() {
	$.getJSON("/generate_example/?"+$("form").serialize(), populate_question);
	$("#answer").val('');
	$("#judgment").text('').removeClass("alert-danger alert-success");
};

var get_scores = function() {
	var total_wrongs = 0;
	var total_rights = 0;
	for (let k in window.scores.rights) {
		total_rights += window.scores.rights[k];
	}
	for (let k in scores.wrongs) {
		total_wrongs += window.scores.wrongs[k];
	}
	var total = total_rights + total_wrongs;
	return {
		"rights": total_rights,
		"wrongs": total_wrongs,
		"total": total_rights+total_wrongs,
		"percent": 100.0 * total_rights / total || 0
	};
};

var display_scores = function() {
	var summed_scores = get_scores();
	$("#rights").text(summed_scores.rights);
	$("#total").text(summed_scores.total);
	$("#percent").text(Math.round(100*summed_scores.percent)/100);
}

var setup_scores = function() {
	var s = localStorage.getItem("scores");
	if (s) {
		window.scores = JSON.parse(s);
	} else {
		// array key is {verbtype|tense|negation|person}
		// verbtype 1 to 6
		// tense 1 = present, 2 = imperfect, 3 = perfect, 4 = pluperfect
		// negation 1 = positive, 2 = negative
		// person 1 = SG1, ... 6 = PL3
		window.scores = {"rights": {}, "wrongs": {}};
		for (var verbtype=1; verbtype<7; verbtype++) {
			for (var tense=1; tense<5; tense++) {
				for (var negative=1; negative<3; negative++) {
					for (var person=1; person<7; person++) {
						var index =	
							verbtype.toString() +
							tense.toString() +
							negative.toString() +
							person.toString();
						window.scores.rights[index] = 0;
						window.scores.wrongs[index] = 0;
					}
				}
			}
		}
		localStorage.setItem("scores", JSON.stringify(window.scores));
	}
};
var clear_scores = function() {
	window.scores = null;
	localStorage.removeItem("scores");
	setup_scores();
	display_scores();
};

$(document).ready( function() {
	setup_scores();
	display_scores();
	get_question();
});
		</script>
	</body>
</html>
